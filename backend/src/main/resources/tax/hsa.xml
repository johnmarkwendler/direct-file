<?xml-model href="./FactDictionaryModule.rng"?>
<FactDictionaryModule>
  <Facts>
    <Fact path="/filersRequiredToFileForm8889">
      <Description>The collection of filers that are required to file form 8889 to report on their HSA contributions
        and/or distributions</Description>
      <Derived>
        <Filter path="/filers">
          <Any>
            <Dependency path="hasMadeContributionsToHsa" />
            <Dependency path="hasHsaDistributions" />
            <!-- TODO: if they acquired an interest in an HSA because of the death of the account beneficiary   -->
            <!-- TODO: if they must include certain amounts in income because they failed to be an eligible individual
            during the testing period -->
          </Any>
        </Filter>
      </Derived>
    </Fact>

    <Fact path="/numberOfFilersRequiredToFileForm8889">
      <Description>The number of filers required to file a 8889.</Description>
      <Derived>
        <CollectionSize>
          <Dependency path="/filersRequiredToFileForm8889" />
        </CollectionSize>
      </Derived>
    </Fact>

    <!-- Really need to refactor hsa-contributions-additional-y-n to single screen -->
    <Fact path="/filers/*/writablePrimaryFilerHasMadeContributionsToHsa">
      <Description>Writable: Whether the primary tp has made contributions to an HSA</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/filers/*/primaryFilerMayHaveOnlyNonW2Contributions">
      <Description>Whether the primary filer might have only non-employer HSA contributions</Description>
      <Derived>
        <All>
          <Dependency path="../mayHaveHsaContributions" />
          <Not>
            <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
          </Not>
          <Dependency module="filers" path="../isPrimaryFiler" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/primaryFilerHasNonW2ContributionsInTy">
      <Description>Whether the primary filer has made non-employer (W2) contributions in the TY</Description>
      <Derived>
        <All>
          <Dependency path="../primaryFilerMayHaveOnlyNonW2Contributions" />
          <Dependency path="../writablePrimaryFilerHasMadeContributionsToHsa" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableSecondaryFilerHasMadeContributionsToHsa">
      <Description>Writable: Whether the secondary tp has made contributions to an HSA</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/flowSecondaryFilerHasNoHsaContributionsOnW2andMFJ">
      <Description>The secondary filer has does not have code W in W2, box 12 and is filing MFJ</Description>
      <Derived>
        <All>
          <Dependency path="/secondaryFiler/mayHaveHsaContributions" />
          <Not>
            <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
          </Not>
          <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/secondaryFilerMayHaveOnlyNonW2Contributions">
      <Description>Whether the secondary filer might have only non-employer HSA contributions</Description>
      <Derived>
        <All>
          <Dependency path="/flowSecondaryFilerHasNoHsaContributionsOnW2andMFJ" />
          <Dependency module="filers" path="../isSecondaryFiler" />
        </All>
      </Derived>
    </Fact>


    <Fact path="/filers/*/secondaryFilerHasNonW2ContributionsInTy">
      <Description>Whether the secondary filer has made non-employer (W2) contributions in the TY</Description>
      <Derived>
        <All>
          <Dependency path="../secondaryFilerMayHaveOnlyNonW2Contributions" />
          <Dependency path="../writableSecondaryFilerHasMadeContributionsToHsa" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/primaryFilerHasMadeContributionsToHsa">
      <Description>Whether the primary tp has made contributions to an HSA</Description>
      <Derived>
        <All>
          <Dependency path="../mayHaveHsaContributions" />
          <Not>
            <Dependency path="../flowSkipToHsaTestingPeriodContributionCheck" />
          </Not>
          <Any>
            <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
            <Dependency path="../primaryFilerHasNonW2ContributionsInTy" />
          </Any>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/secondaryFilerHasMadeContributionsToHsa">
      <Description>Whether the secondary tp has made contributions to an HSA</Description>
      <Derived>
        <All>
          <Dependency path="../mayHaveHsaContributions" />
          <Not>
            <Dependency path="../flowSkipToHsaTestingPeriodContributionCheck" />
          </Not>
          <Any>
            <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
            <Dependency path="../secondaryFilerHasNonW2ContributionsInTy" />
          </Any>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowSkipToHsaTestingPeriodContributionCheck">
      <Description>Whether the filer doesn't have contributions in the TY and should skip to the testing period section
        instead of answering the remaining coverage and contribution questions.</Description>
      <Derived>
        <Any>
          <All>
            <Dependency path="../primaryFilerMayHaveOnlyNonW2Contributions" />
            <Not>
              <Dependency path="../primaryFilerHasNonW2ContributionsInTy" />
            </Not>
          </All>
          <All>
            <Dependency path="../secondaryFilerMayHaveOnlyNonW2Contributions" />
            <Not>
              <Dependency path="../secondaryFilerHasNonW2ContributionsInTy" />
            </Not>
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasHsaContributionsAndCanBeClaimedAsDependent">
      <Description>Whether the filer has contributions and can be claimed as a dependent. KO condition for TY24</Description>
      <Derived>
        <All>
          <Dependency path="../hasMadeContributionsToHsa" />
          <Dependency module="filers" path="../canBeClaimed" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutFilerIsDependentAndContributesToHsa">
      <Name>Knockout when Box 12 has contributions for code W but TP is dependent</Name>
      <Description>Filer has entered W2 contributions for HSA in Box 12 and has dependency status</Description>
      <Export downstreamFacts="true" />
      <Derived>
        <Any>
          <Dependency path="/primaryFiler/hasHsaContributionsAndCanBeClaimedAsDependent" />
          <Dependency path="/secondaryFiler/hasHsaContributionsAndCanBeClaimedAsDependent" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasHsaContributionsNotExceedLimits">
      <Description>The TP has HSA contributions which do not exceed limits.</Description>
      <Derived>
        <Any>
          <All>
            <Dependency module="filers" path="../isPrimaryFiler" />
            <GreaterThan>
              <Left>
                <Dependency path="../hsaContributionsTotal" />
              </Left>
              <Right>
                <Dollar>0</Dollar>
              </Right>
            </GreaterThan>
            <!-- <Not>
              <Dependency path="../hsaContributionLimitExceeded" />
            </Not> -->
          </All>
          <All>
            <Dependency module="filers" path="../isSecondaryFiler" />
            <GreaterThan>
              <Left>
                <Dependency path="../hsaContributionsTotal" />
              </Left>
              <Right>
                <Dollar>0</Dollar>
              </Right>
            </GreaterThan>
            <!-- <Not>
              <Dependency path="../hsaContributionLimitExceeded" />
            </Not> -->
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/someFilersHaveHsaContributionsNotExceedLimits">
      <Description>The TP has HSA contributions which do not exceed limits.</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/hasHsaContributionsNotExceedLimits" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/requiresForm8889">
      <Description>Whether the TP is required to file one or more form 8889s reporting on their HSAs</Description>

      <Derived>
        <GreaterThan>
          <Left>
            <Dependency path="/numberOfFilersRequiredToFileForm8889" />
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hasHsaMedicalSavingsAccountType">
      <Description>Whether the user has a medical savings account</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hasHsaMedicalSavingsAccountTypeDerived">
      <Description>Whether the user has a medical savings account after accounting for edit conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/someFilerHasSomeHsaActivityNotConsideringKos" />
            </When>
            <Then>
              <Dependency path="/hasHsaMedicalSavingsAccountType" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowToExcessContributionsPreviousYear">
      <Description>Flow to the hsa-excess-contributions-previous-year screen</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="/hasHsaMedicalSavingsAccountTypeDerived" />
          </IsComplete>
          <Not>
            <Dependency path="/hasHsaMedicalSavingsAccountTypeDerived" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/writableHasHsaExcessContributionsPreviousYear">
      <Description>Writable: Whether the tp has excess HSA Contributions from the previous year</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hasHsaExcessContributionsPreviousYear">
      <Description>Whether the tp has excess HSA Contributions from the previous year after accounting for edit
        conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/flowToExcessContributionsPreviousYear" />
            </When>
            <Then>
              <Dependency path="/writableHasHsaExcessContributionsPreviousYear" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/skipToHsaExcessContributions">
      <Description>When /writableHasHsaExcessContributionsPreviousYear is False then skip to the
        hsa-excess-contributions-y-n screen</Description>
      <Derived>
        <All>
          <Not>
            <Dependency path="/hasHsaExcessContributionsPreviousYear" />
          </Not>
          <Not>
            <Dependency path="/hasHsaMedicalSavingsAccountTypeDerived" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowToHsaExcessContributions">
      <Description>Flow to the hsa-excess-contributions-y-n screen</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="/skipToHsaExcessContributions" />
          </IsComplete>
          <Dependency path="/skipToHsaExcessContributions" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/writableHasHsaWithdrawnExcessContributionsYesNo">
      <Description>Writable: Whether the tp has withdrawn excess HSA contributions before the tax day </Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hasHsaWithdrawnExcessContributionsYesNo">
      <Description>Whether the tp has withdrawn excess HSA contributions before the tax day after accounting for edit
        conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/flowToHsaExcessContributions" />
            </When>
            <Then>
              <Dependency path="/writableHasHsaWithdrawnExcessContributionsYesNo" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaExcessContributions">
      <Description>Knockout due to excess contributions before answering coverage and contributions section questions</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <Any>
          <Dependency path="/hasHsaExcessContributionsPreviousYear" />
          <Dependency path="/hasHsaWithdrawnExcessContributionsYesNo" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaMedicalSavingsAccountType">
      <Name>Knockout Due to a Medical Savings Account</Name>
      <Description>Has a set of facts that cause a knockout</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <All>
          <Not>
            <Dependency path="/flowToExcessContributionsPreviousYear" />
          </Not>
          <Not>
            <Dependency path="/flowToHsaExcessContributions" />
          </Not>
          <Dependency path="/hasHsaMedicalSavingsAccountTypeDerived" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/hasHsaDistributions">
      <Name>Has HSA Distributions</Name>
      <Description>Whether there are any HSA distributions listed</Description>

      <Derived>
        <GreaterThan>
          <Left>
            <CollectionSize>
              <Dependency path="/hsaDistributions" />
            </CollectionSize>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/isHsaSectionComplete">
      <Description>Whether the HSA Section is complete</Description>
      <Export downstreamFacts="true" />

      <Derived>
        <All>
          <!-- Intro section always needs to be complete -->
          <Dependency path="/hsaIntroSectionIsComplete" />
          <!-- check for completeness of the testing period contribution check  -->
          <Dependency path="/hsaTestingPeriodCheckSectionIsComplete" />
          <Any>
            <!-- No HSA activity -->
            <Not>
              <Dependency path="/someFilerHasSomeHsaActivity" />
            </Not>
            <!-- Or TP has completed Coverage and contributions + distributions -->
            <All>
              <Dependency path="/hsaCoverageAndContributionsSectionIsComplete" />
              <Dependency path="/hasCompletedHsaDistributions" />
            </All>
          </Any>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaIntroSectionIsComplete">
      <Description>Whether the TP has answered all the required sections in the HSA intro section</Description>
      <Derived>
        <All>
          <!--          Primary Filer has completed their intro questions-->
          <Any>
            <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
            <All>
              <Not>
                <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
              </Not>
              <IsComplete>
                <Dependency path="/someFilerHadNonW2HsaActivity" />
              </IsComplete>
              <Any>
                <Not>
                  <Dependency path="/someFilerHadNonEmployerHsaActivity" />
                </Not>
                <All>
                  <Dependency path="/someFilerHadNonEmployerHsaActivity" />
                  <IsComplete>
                    <Dependency path="/writablePrimaryFilerHadNonW2HsaActivity" />
                  </IsComplete>
                </All>
              </Any>
            </All>
          </Any>
          <!--         Secondary filer has completed their intro questions, if required -->
          <Any>
            <Not>
              <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
            </Not>
            <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
            <All>
              <Not>
                <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
              </Not>
              <IsComplete>
                <Dependency path="/someFilerHadNonW2HsaActivity" />
              </IsComplete>
              <Any>
                <Not>
                  <Dependency path="/someFilerHadNonEmployerHsaActivity" />
                </Not>
                <All>
                  <Dependency path="/someFilerHadNonEmployerHsaActivity" />
                  <IsComplete>
                    <Dependency path="/writableSecondaryFilerHadNonW2HsaActivity" />
                  </IsComplete>
                </All>
              </Any>
            </All>
          </Any>
          <!--          If any filers have HSA activity, they've answered all subsequent questions -->
          <Any>
            <Not>
              <Dependency path="/someFilerHasSomeHsaActivityNotConsideringKos" />
            </Not>
            <All>
              <Dependency path="/someFilerHasSomeHsaActivityNotConsideringKos" />
              <IsComplete>
                <Dependency path="/hasHsaMedicalSavingsAccountType" />
              </IsComplete>
              <Any>
                <Not>
                  <Dependency path="/flowToExcessContributionsPreviousYear" />
                </Not>
                <IsComplete>
                  <Dependency path="/writableHasHsaExcessContributionsPreviousYear" />
                </IsComplete>
              </Any>
              <Any>
                <Not>
                  <Dependency path="/flowToHsaExcessContributions" />
                </Not>
                <IsComplete>
                  <Dependency path="/writableHasHsaWithdrawnExcessContributionsYesNo" />
                </IsComplete>
              </Any>
            </All>
          </Any>
        </All>
      </Derived>
    </Fact>

    <Fact path="/isFilingStatusMfjOrMfs">
      <Description>Whether the filing status is MFJ or MFS</Description>
      <Derived>
        <Any>
          <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          <Dependency module="filingStatus" path="/isFilingStatusMFS" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/hsaCoverageAndContributionsSectionIsComplete">
      <Description>Whether the TP's HSA coverage and contributions section can be considered complete</Description>
      <Derived>
        <Equal>
          <Left>
            <CollectionSize>
              <Dependency path="/filersWithHsa" />
            </CollectionSize>
          </Left>
          <Right>
            <CollectionSize>
              <Filter path="/filersWithHsa">
                <Dependency path="hasCompletedCoverageAndContribution" />
              </Filter>
            </CollectionSize>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/mfjBothFilersHaveHsaContributionsOnW2">
      <Description>Whether both filers have employer HSA contributions.</Description>
      <Derived>
        <All>
          <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
          <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasMadeContributionsToHsa">
      <Description>Whether the filer has made contributions to an HSA and must file form 8889.</Description>
      <Derived>
        <Any>
          <All>
            <Dependency module="filers" path="../isPrimaryFiler" />
            <Dependency path="../primaryFilerHasMadeContributionsToHsa" />
          </All>
          <All>
            <Dependency module="filers" path="../isSecondaryFiler" />
            <Dependency path="../secondaryFilerHasMadeContributionsToHsa" />
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/mayHaveHsaContributions">
      <Description>Whether the filer has HSA contributions and we may need to collect additional coverage and
        contribution information. This sets up the questions to ask on the per filer basis. One of which is that they
        did not have any contributions.</Description>
      <Derived>
        <All>
          <Dependency path="../mayHaveHsaContributionsNotConsideringKos" />
          <Not>
            <Dependency path="/flowKnockoutHsaExcessContributions" />
          </Not>
          <Not>
            <Dependency path="/flowKnockoutHsaMedicalSavingsAccountType" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/mayHaveHsaContributionsNotConsideringKos">
      <Description>Whether the filer may have HSA activity before accounting for KOs in the intro section</Description>
      <Derived>
        <Any>
          <All>
            <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
            <Dependency module="filers" path="../isSecondaryFiler" />
            <Any>
              <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
              <All>
                <Dependency path="/secondaryFilerHadNonW2HsaActivity" />
                <Dependency path="/someFilerHadNonEmployerHsaActivity" />
              </All>
            </Any>
          </All>
          <All>
            <Dependency module="filers" path="../isPrimaryFiler" />
            <Any>
              <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
              <All>
                <Dependency path="/primaryFilerHadNonW2HsaActivity" />
                <Dependency path="/someFilerHadNonEmployerHsaActivity" />
              </All>
            </Any>
          </All>
        </Any>
      </Derived>
    </Fact>

    <!-- this fact is always = $0 because HSA funding distributions are not covered as of October 2024 -->
    <Fact path="/filers/*/hsaFundingDistributionsTotal">
      <Description>Total qualified HSA funding distribution. This is reported on the primary filer's Form 8889 line 10</Description>
      <Export mef="true" />
      <Derived>
        <Dollar>0</Dollar>
      </Derived>
    </Fact>

    <!-- Might make sense to rename this collection to something specific to contributions when it won't cause conflicts -->
    <Fact path="/filersWithHsa">
      <Description>The collection of filers with HSA contribution information we may need to collect</Description>

      <Derived>
        <Filter path="/filers">
          <Dependency path="mayHaveHsaContributions" />
        </Filter>
      </Derived>
    </Fact>

    <Fact path="/filersWithHsaContributions">
      <Description>The collection of filers with HSA contributions that must file Form 8889 Part 1</Description>
      <Derived>
        <Filter path="/filersWithHsa">
          <Dependency path="hasMadeContributionsToHsa" />
        </Filter>
      </Derived>
    </Fact>

    <Fact path="/bothFilersHaveHsa">
      <Description>Whether the filing status is MFJ and both filers have separate HSAs</Description>
      <Derived>
        <Equal>
          <Left>
            <CollectionSize>
              <Dependency path="/filersWithHsaContributions" />
            </CollectionSize>
          </Left>
          <Right>
            <Int>2</Int>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/flowShowHsaYesNo">
      <Description>Whether to show the screen that asks about HSA activity</Description>
      <Derived>
        <Any>
          <Not>
            <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
          </Not>
          <All>
            <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
            <Not>
              <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
            </Not>
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/someFilerHadNonW2HsaActivity">
      <Description>Whether some filer had non-W2 HSA activity</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/someFilerHadNonEmployerHsaActivity">
      <Description>Whether some filer had non-W2 HSA activity after accounting for edit conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/flowShowHsaYesNo" />
            </When>
            <Then>
              <Dependency path="/someFilerHadNonW2HsaActivity" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/writableDistributionsRolloverBool">
      <Description>Whether any of the distributions from box 1 are a rollover to another HSA</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/writableDistributionsRolloverAmount">
      <Description>The total amount of distributions that were a rollover to another HSA</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/distributionsRolloverAmount">
      <Description>The total amount of distributions that were a rollover to another HSA</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="../writableDistributionsRolloverBool" />
                <IsComplete>
                  <Dependency path="../writableDistributionsRolloverAmount" />
                </IsComplete>
              </All>
            </When>
            <Then>
              <Dependency path="../writableDistributionsRolloverAmount" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowShowHsaPrimaryYesNo">
      <Description>Whether to show the screen that asks about HSA activity for the primary filer</Description>
      <Derived>
        <All>
          <Dependency path="/someFilerHadNonEmployerHsaActivity" />
          <Not>
            <Dependency module="formW2s" path="/hasPrimaryFilerHsaContributionsFromW2s" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowShowHsaMfsLine6Check">
      <Description>Whether the filer will see the hsa coverage screen for the MFS line 6 check.</Description>
      <Derived>
        <All>
          <Dependency module="filers" path="/isMarried" />
          <Not>
            <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          </Not>
          <Dependency path="../flowShouldAskForHsaHdhpCoverageType" />
          <Dependency path="../hasFamilyHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableMfsLine6Check">
      <Description>Writable: whether a Health Savings Account (HSA) had contributions for the tax year</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/filers/*/mfsLine6Check">
      <Description>Whether a Health Savings Account (HSA) had contributions for the tax year</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../flowShowHsaMfsLine6Check" />
            </When>
            <Then>
              <Dependency path="../writableMfsLine6Check" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/causesHsaMfsLine6Knockout">
      <Description>Whether the filer is knocked out due to their HSA contributions</Description>
      <Derived>
        <Dependency path="../mfsLine6Check" />
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutMFSLine6Check">
      <Description>When Primary TP who is MFS has a spouse that had HSA contributions during the tax year, they are
        knocked out</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <Dependency path="/primaryFiler/causesHsaMfsLine6Knockout" />
      </Derived>
    </Fact>

    <Fact path="/writablePrimaryFilerHadNonW2HsaActivity">
      <Description>Whether primary filer had non-W2 HSA activity</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/primaryFilerHadNonW2HsaActivity">
      <Description>Whether primary filer had non-W2 HSA activity</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/flowShowHsaPrimaryYesNo" />
            </When>
            <Then>
              <Dependency path="/writablePrimaryFilerHadNonW2HsaActivity" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowShowHsaSecondaryYesNo">
      <Description>Whether to show the screen that asks about HSA activity for the secondary filer</Description>
      <Derived>
        <All>
          <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          <Dependency path="/flowShowHsaYesNo" />
          <Dependency path="/someFilerHadNonEmployerHsaActivity" />
          <Not>
            <Dependency module="formW2s" path="/hasSecondaryFilerHsaContributionsFromW2s" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/writableSecondaryFilerHadNonW2HsaActivity">
      <Description>Whether secondary filer had non-W2 HSA activity</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/secondaryFilerHadNonW2HsaActivity">
      <Description>Whether secondary filer had non-W2 HSA activity</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/flowShowHsaSecondaryYesNo" />
            </When>
            <Then>
              <Dependency path="/writableSecondaryFilerHadNonW2HsaActivity" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/someFilerHasSomeHsaActivityNotConsideringKos">
      <Description>Whether at least one filer had some HSA activity before accounting for intro section KOs</Description>
      <Derived>
        <Any>
          <Dependency path="/primaryFiler/mayHaveHsaContributionsNotConsideringKos" />
          <Dependency path="/secondaryFiler/mayHaveHsaContributionsNotConsideringKos" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/someFilerHasSomeHsaActivity">
      <Description>Whether at least one filer has HSA activity. If
        true, we will need to
        learn about the HSA account type,
        coverage, contributions, and distributions for the filer.</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <CollectionSize>
              <Dependency path="/filersWithHsa" />
            </CollectionSize>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasCompletedCoverageAndContribution">
      <Description>Whether the filer has completed the required HSA coverage and contributions
        sections</Description>
      <Derived>
        <Any>
          <!-- complete if they didn't have any coverage / contributions in that year -->
          <Not>
            <Dependency path="../hasMadeContributionsToHsa" />
          </Not>
          <!-- Or they completed all the required questions in the section -->
          <All>
            <IsComplete>
              <Dependency path="../hasMadeContributionsToHsa" />
            </IsComplete>
            <IsComplete>
              <Dependency path="../enrolledInMedicare" />
            </IsComplete>
            <IsComplete>
              <Dependency path="../hsaHdhpCoverageStatus" />
            </IsComplete>
            <IsComplete>
              <Dependency path="../typeOfHdhp" />
            </IsComplete>
            <IsComplete>
              <Dependency path="../hadOtherCoverageIneligibleForHSA" />
            </IsComplete>
            <Any>
              <Not>
                <Dependency path="../flowShowHsaMfsLine6Check" />
              </Not>
              <IsComplete>
                <Dependency path="../writableMfsLine6Check" />
              </IsComplete>
            </Any>
            <Any>
              <Not>
                <Dependency path="../flowShouldAskForChangeInMaritalStatusDuringTaxYear" />
              </Not>
              <IsComplete>
                <Dependency path="../writableChangeInMaritalStatusDuringTaxYear" />
              </IsComplete>
            </Any>
            <Any>
              <Not>
                <Dependency path="../flowShouldAskIfChangeInMaritalStatusAffectsContributionLimit" />
              </Not>
              <IsComplete>
                <Dependency path="../writableMaritalChangeAffectContributionLimitBool" />
              </IsComplete>
            </Any>
            <!-- These two are optional (i.e. we don't need to check their completeness for this section): -->
            <!-- hsa-contributions-add-contributions-made-ty -->
            <!-- hsa-contributions-add-contributions-made-ty+1 -->
            <IsComplete>
              <Dependency path="../hasMadeQualifiedHsaFundingDistribution" />
            </IsComplete>
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/hsaHdhpCoverageStatusOptions">
      <Description>Options for a filers high deductible health plan (HDHP) status</Description>
      <Derived>
        <EnumOptions>
          <String>allYear</String>
          <String>partOfYear</String>
          <String>noneOfYear</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaHdhpCoverageStatus">
      <Description>Whether the filer had a HDHP for all, part, or none of the year</Description>
      <Writable>
        <Enum optionsPath="/hsaHdhpCoverageStatusOptions" />
      </Writable>
    </Fact>

    <Fact path="/filers/*/hsaHdhpCoverageStatusDerived">
      <Description>Whether the filer had a HDHP for all, part, or none of the year. After accounting for edit
        conditions.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="../hasMadeContributionsToHsa" />
                <Not>
                  <Dependency path="/flowKnockoutHdhpCoverageStatusNotNeeded" />
                </Not>
              </All>
            </When>
            <Then>
              <Dependency path="../hsaHdhpCoverageStatus" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/causesEarningsOnExcessContributionsKO">
      <Name>HSA earnings on excess contributions knockout</Name>
      <Description>Filer has entered more than $0 on Box 2 for HSA distributions, knocking them out</Description>

      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="/someFilerCanHaveDistribution" />
                <IsComplete>
                  <Dependency path="../writableEarningsOnExcessContributions" />
                </IsComplete>
                <GreaterThan>
                  <Left>
                    <Dependency path="../writableEarningsOnExcessContributions" />
                  </Left>
                  <Right>
                    <Dollar>0</Dollar>
                  </Right>
                </GreaterThan>
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutEarningsOnExcessContributions">
      <Name>HSA earnings on excess contributions flow knockout</Name>
      <Description>Flow knockout form when a filer has entered more than $0 on Box 2 for HSA distributions, knocking
        them out</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/hsaDistributions/*/causesEarningsOnExcessContributionsKO" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributionCodeOptions">
      <Description>Distribution code options for 1099-SA Box3</Description>
      <Derived>
        <EnumOptions>
          <String>normalDistribution</String>
          <String>excessContributions</String>
          <String>disability</String>
          <String>deathOtherThanCode6</String>
          <String>prohibitedTransaction</String>
          <String>deathDistributionAfterYear</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/hsaDistributionCode">
      <Name>hsa distribution code 1099-SA </Name>
      <Description>Box 3 of form 1099-SA: Distribution code</Description>
      <Writable>
        <Enum optionsPath="/hsaDistributionCodeOptions" />
      </Writable>
    </Fact>

    <Fact path="/filers/*/hsaHdhpCoverageStatusKnockout">
      <Description>Whether the filer is knocked out due to their HDHP coverage status.</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../hsaHdhpCoverageStatusDerived" />
          </IsComplete>
          <Equal>
            <Left>
              <Dependency path="../hsaHdhpCoverageStatusDerived" />
            </Left>
            <Right>
              <Enum optionsPath="/hsaHdhpCoverageStatusOptions">partOfYear</Enum>
            </Right>
          </Equal>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasHsaDistributions">
      <Description>Whether the filer has HSA distributions.</Description>
      <Derived>
        <All>
          <Dependency path="../hasHsaCanHaveDistribution" />
          <GreaterThan>
            <Left>
              <Dependency path="../totalHsaDistributions" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </GreaterThan>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hadCoverageDisqualifyingHsaContributions">
      <Description>Whether the filer had coverage disquailfying HSA contributions.</Description>
      <Derived>
        <False />
      </Derived>
    </Fact>

    <Fact path="/filers/*/wasEligibleToMakeHsaContributionsAllYear">
      <Description>Whether the filer was eligible to make HSA contributions all year. Rule of last year does not apply.</Description>
      <Derived>
        <All>
          <Dependency path="../hasHdhpCoverageAllYear" />
          <Equal>
            <Left>
              <Dependency path="../enrolledInMedicareDerived" />
            </Left>
            <Right>
              <Enum optionsPath="/enrolledInMedicareOptions">noneOfYear</Enum>
            </Right>
          </Equal>
          <Not>
            <Dependency path="../hadCoverageDisqualifyingHsaContributions" />
          </Not>
          <Not>
            <Dependency module="filers" path="../canBeClaimed" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions">
      <Description>The distributions associated with an HSA</Description>
      <Writable>
        <Collection />
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/filer">
      <Description>The filer who the HSA distributions belong to.</Description>
      <Writable>
        <CollectionItem collection="/filers" />
      </Writable>
      <Placeholder>
        <Dependency module="filers" path="/primaryFiler" />
      </Placeholder>
    </Fact>

    <Fact path="/filers/*/hsaDistributionNotNormalKnockout">
      <Description>Whether the filer is knocked out due to their HSA distribution code other than 1</Description>
      <Derived>
        <All>
          <Dependency path="/someFilerCanHaveDistribution" />
          <IsComplete>
            <Dependency path="/hsaDistributions/*/hsaDistributionCode" />
          </IsComplete>
          <Not>
            <Equal>
              <Left>
                <Dependency path="/hsaDistributions/*/hsaDistributionCode" />
              </Left>
              <Right>
                <Enum optionsPath="/hsaDistributionCodeOptions">normalDistribution</Enum>
              </Right>
            </Equal>
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaDistributionsNotNormal">
      <Description>Knockout due to any of filers having HSA distribution code other than 1</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/hsaDistributionNotNormalKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaDistributionCode">
      <Name>Knockout due to distribution code not being normal distribution</Name>
      <Description>User selects HSA distribution code other than code 1</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />
      <Derived>
        <Dependency path="/flowKnockoutHsaDistributionsNotNormal" />
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/writableGrossDistribution">
      <Description>Box 1 of form 1099-SA: Gross Distribution</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/grossDistribution">
      <Description>Box 1 of form 1099-SA: Gross Distribution</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <IsComplete>
                <Dependency path="../writableGrossDistribution" />
              </IsComplete>
            </When>
            <Then>
              <Dependency path="../writableGrossDistribution" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/modifiedDistribution">
      <Description>Writable gross distribution minus distribution rollovers minus excess withdrawn amount</Description>
      <Derived>
        <Subtract>
          <Minuend>
            <Dependency path="../grossDistribution" />
          </Minuend>
          <Subtrahends>
            <Add>
              <Dependency path="../distributionsRolloverAmount" />
              <Dependency path="../withdrawnExcessContributionsAmount" />
            </Add>
          </Subtrahends>
        </Subtract>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/writableTrusteeName">
      <Description>The entity that paid the hsa distribution</Description>
      <Writable>
        <String />
        <Limit type="Match">
          <String><![CDATA[[\sA-Za-z0-9\-]+]]></String>
        </Limit>
        <Limit type="MaxLength">
          <Int>75</Int>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/hasWithdrawnExcessContributions">
      <Description>Whether part of the total distributions withdrawn were excess contributions</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/writableWithdrawnExcessContributionsAmount">
      <Description>Amount of excess contributions and earnings on them withdrawn before the end of the tax year.</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/withdrawnExcessContributionsAmount">
      <Description>Amount of excess contributions and earnings on them withdrawn before the end of the tax year.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="../hasWithdrawnExcessContributions" />
                <IsComplete>
                  <Dependency path="../writableWithdrawnExcessContributionsAmount" />
                </IsComplete>
              </All>
            </When>
            <Then>
              <Dependency path="../writableWithdrawnExcessContributionsAmount" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/hasWithdrawnMoreThanGrossDistributions">
      <Description>Whether the excess withdrawn contributions is greater than the gross distributions amount.</Description>
      <Derived>
        <All>
          <Dependency path="../hasWithdrawnExcessContributions" />
          <GreaterThan>
            <Left>
              <Dependency path="../withdrawnExcessContributionsAmount" />
            </Left>
            <Right>
              <Dependency path="../writableGrossDistribution" />
            </Right>
          </GreaterThan>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/hasRolloverAmountMoreThanGrossDistributions">
      <Description>Whether the rollover amount is greater than the gross distributions amount.</Description>
      <Derived>
        <All>

          <Dependency path="../writableDistributionsRolloverBool" />
          <GreaterThan>
            <Left>
              <Dependency path="../writableDistributionsRolloverAmount" />
            </Left>
            <Right>
              <Dependency path="../writableGrossDistribution" />
            </Right>
          </GreaterThan>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/writableEarningsOnExcessContributions">
      <Description>Box 2 of form 1099-SA: Earnings on excess contributions</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/writableFmvOnDateOfDeath">
      <Description>Box 4 of form 1099-SA: fair market value on date of death</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/writableQualifiedMedExpenses">
      <Description>Total amount of qualified medical expenses paid for in tax year using
        distributions from this HSA
        account. Informs form 8889, line 15</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/secondaryFilerUsedWithoutMFJ">
      <Name>Secondary filer has HSA distribution Form 8889 when primary filer is not filing jointly</Name>
      <Description>Whether secondary filer has HSA distribution records when primary filer is not filing jointly</Description>

      <Derived>
        <All>
          <!-- We only display the distribution section if someone could have distributions so only need to alert if
          some filer can have distributions -->
          <Dependency path="/someFilerCanHaveDistribution" />
          <Not>
            <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          </Not>
          <Dependency path="../belongsToSecondaryFiler" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/hasDistributionsWithoutHsaActivity">
      <Description>Whether the filer had distributions as form 8889 listed after claiming they had no HSA activity</Description>
      <Derived>
        <All>
          <!-- We only display the distribution section if someone could have distributions so only need to alert if
          some filer can have distributions -->
          <Dependency path="/someFilerCanHaveDistribution" />
          <!-- We want to give precedence to the secondary filer error and not create a double error -->
          <Not>
            <Dependency path="../secondaryFilerUsedWithoutMFJ" />
          </Not>
          <IsComplete>
            <Dependency path="../filer/hasHsaCanHaveDistribution" />
          </IsComplete>
          <Not>
            <Dependency path="../filer/hasHsaCanHaveDistribution" />
          </Not>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hasHsaDistributionsWithoutActivity">
      <Description>Whether the TP has any distributions that must be removed because they reported not having HSA
        activity in the TY</Description>
      <BlockSubmissionOnTrue />

      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/hsaDistributions/*/hasDistributionsWithoutHsaActivity" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/secondaryFilerUsedWithoutMFJ">
      <Name>Secondary filer has HSA distribution Form 8889 when primary filer is not filing jointly</Name>
      <Description>Whether secondary filer has HSA distribution records when primary filer is not filing jointly</Description>
      <BlockSubmissionOnTrue />

      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/hsaDistributions/*/secondaryFilerUsedWithoutMFJ" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/hasSeenLastAvailableScreen">
      <Description>Whether the filer has completed the HSA distributions</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/hsaDistributions/*/isComplete">
      <Description>Whether the filer has completed the HSA distributions</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../writableDistributionsRolloverBool" />
          </IsComplete>
          <IsComplete>
            <Dependency path="../writableTrusteeName" />
          </IsComplete>
          <IsComplete>
            <Dependency path="../writableGrossDistribution" />
          </IsComplete>
          <Any>
            <Not>
              <Dependency path="../writableDistributionsRolloverBool" />
            </Not>
            <IsComplete>
              <Dependency path="../writableDistributionsRolloverAmount" />
            </IsComplete>
          </Any>
          <IsComplete>
            <Dependency path="../hasWithdrawnExcessContributions" />
          </IsComplete>
          <Any>
            <Not>
              <Dependency path="../hasWithdrawnExcessContributions" />
            </Not>
            <IsComplete>
              <Dependency path="../writableWithdrawnExcessContributionsAmount" />
            </IsComplete>
          </Any>
          <IsComplete>
            <Dependency path="../hsaDistributionCode" />
          </IsComplete>
          <IsComplete>
            <Dependency path="../writableQualifiedMedExpenses" />
          </IsComplete>
          <IsComplete>
            <Dependency path="../hasSeenLastAvailableScreen" />
          </IsComplete>
          <Dependency path="../hasSeenLastAvailableScreen" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/hasCompletedHsaDistributions">
      <Description>Whether the HSA distributions section can be considered done.</Description>
      <Derived>
        <Any>
          <Not>
            <Dependency path="/someFilerCanHaveDistribution" />
          </Not>
          <All>
            <IsComplete>
              <Dependency path="/hsaDistributionsIsDone" />
            </IsComplete>
            <Dependency path="/hsaDistributionsIsDone" />
          </All>
        </Any>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributionsIsDone">
      <Description>Whether the TP is done adding the HSA distributions</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/filers/*/flowShouldAskForHsaHdhpCoverageType">
      <Description>Whether we should ask the filer about their HDHP coverage type</Description>
      <Derived>
        <All>
          <Not>
            <Dependency path="/flowKnockoutHsaCoverageChanging" />
          </Not>
          <Not>
            <Dependency path="/flowKnockoutNotEnrolledInHdhp" />
          </Not>
          <Dependency path="../hasHdhpCoverageAllYear" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowShouldAskHadCoverageIneligibleForHSAContributions">
      <Description>Whether we should ask if the filer had any other coverage that would make them ineligible for HSA
        contributions</Description>
      <Derived>
        <All>
          <Dependency path="../flowShouldAskForHsaHdhpCoverageType" />
          <Dependency path="../hasSelfOnlyOrFamilyHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaNonemployerContributionsTotal">
      <Description>Filer's total nonemployer HSA contributions. Use for downstream calculations.</Description>
      <Derived>
        <Add>
          <Dependency path="../hsaNonemployerContributionsTaxYear" />
          <Dependency path="../hsaNonemployerContributionsTaxYearPlusOne" />
        </Add>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaNonemployerContributionsTotalForExport">
      <Description>Primary filer's total nonemployer HSA contributions. This is reported on the primary filer's Form
        8889 line 2. Sometimes left incomplete.</Description>
      <Export mef="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Dependency path="../hsaNonemployerContributionsTotal" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionsW2sTotal">
      <Description>A Filer's HSA total employer contributions reported on W-2s</Description>
      <Export mef="true" />

      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency module="filers" path="../isSecondaryFiler" />
              </All>
            </When>
            <Then>
              <Round>
                <Dependency module="formW2s" path="/secondaryFilerTotalHsaContributionsFromW2s" />
              </Round>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Round>
                <Dependency module="formW2s" path="/primaryFilerTotalHsaContributionsFromW2s" />
              </Round>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaTotalContributionLimit">
      <Description>Form 8889 Line 8: the total contribution limit for the filer</Description>
      <Export mef="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Round>
                <Add>
                  <Dependency path="../hsaContributionLimitLessAddition" />
                  <Dependency path="../additionToHsaContributionLimit" />
                </Add>
              </Round>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionsTotal">
      <Description>A filer's HSA total employer and non-employer contributions</Description>
      <Derived>
        <Round>
          <Add>
            <Dependency path="../hsaEmployerContributionsAndFundingDistributionTotal" />
            <Dependency path="../hsaNonemployerContributionsTotal" />
          </Add>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaEmployerContributionsAndFundingDistributionTotal">
      <Description>Form 8889 Line 11: the sum of the employer contributions and their qualified HSA funding
        distributions. Always complete; use for computations.</Description>
      <Derived>
        <Round>
          <Add>
            <Dependency path="../hsaContributionsW2sTotal" />
            <Dependency path="../hsaFundingDistributionsTotal" />
          </Add>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaEmployerContributionsAndFundingDistributionTotalForExport">
      <Description>Form 8889 Line 11 for use by PDF and XML outputs; sometimes left incomplete.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Dependency path="../hsaEmployerContributionsAndFundingDistributionTotal" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionLimitLessLine11">
      <Description>Form 8889 Line 12: the total contribution limit less sum of the employer contributions and their
        qualified HSA funding
        distributions.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <GreaterOf>
                <Dollar>0</Dollar>
                <Subtract>
                  <Minuend>
                    <Dependency path="../hsaTotalContributionLimit" />
                  </Minuend>
                  <Subtrahends>
                    <Dependency path="../hsaEmployerContributionsAndFundingDistributionTotal" />
                  </Subtrahends>
                </Subtract>
              </GreaterOf>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaTotalDeductibleAmount">
      <Description>
        Form 8889 Line 13: The total deductible amount based off the filer's HSA coverage and contributions.

        Complete when the filer hasMadeContributionsToHsa
      </Description>
      <Export mef="true" stateSystems="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <LesserOf>
                <Dependency path="../hsaNonemployerContributionsTotal" />
                <Dependency path="../hsaContributionLimitLessLine11" />
              </LesserOf>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasHsaDeduction">
      <Description>Whether the filer has a deductible amount</Description>
      <Derived>
        <All>
          <Dependency path="../hasMadeContributionsToHsa" />
          <GreaterThan>
            <Left>
              <Dependency path="../hsaTotalDeductibleAmount" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </GreaterThan>
        </All>
      </Derived>
    </Fact>

    <Fact path="/isFilingMfJAndBothFilersHaveHsaDeductions">
      <Description>Whether the TP is married filing jointly and both filers have HSA deductions</Description>
      <Derived>
        <All>
          <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
          <Dependency path="/primaryFiler/hasHsaDeduction" />
          <Dependency path="/secondaryFiler/hasHsaDeduction" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/bothFilersHsaNonEmployerContributionsTotal">
      <Description>Amount of both filers' HSA total non-employer contributions</Description>
      <Derived>
        <Add>
          <Dependency path="/primaryFiler/hsaNonemployerContributionsTotal" />
          <Dependency path="/secondaryFiler/hsaNonemployerContributionsTotal" />
        </Add>
      </Derived>
    </Fact>

    <Fact path="/hasHsaDeduction">
      <Description>Whether the TP (either filer or spouse) has any deductible amount based on their HSA contributions</Description>
      <Derived>
        <Any>
          <Dependency path="/primaryFiler/hasHsaDeduction" />
          <Dependency path="/secondaryFiler/hasHsaDeduction" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasExcessHsaContributions">
      <Description>Whether the filer had excess contributions and may be required to pay additional tax</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Dependency path="../hsaNonemployerContributionsTotal" />
          </Left>
          <Right>
            <Dependency path="../hsaTotalDeductibleAmount" />
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hsaTotalDeductibleAmount">
      <Description>The total deductible amount based off the taxpayer's (filer and spouse when applicable) HSA coverage
        and contributions</Description>
      <Export downstreamFacts="true" mef="true" />
      <ExportZero />
      <Derived>
        <!-- We need a switch here because otherwise this would always have a 0 value (even when the TP didn't have an
        HSA) -->
        <Switch>
          <Case>
            <When>
              <!-- If we use /hasHsaDeduction here we wouldn't be able to export zero values-->
              <Any>
                <Dependency path="/primaryFiler/hasMadeContributionsToHsa" />
                <Dependency path="/secondaryFiler/hasMadeContributionsToHsa" />
              </Any>
            </When>
            <Then>
              <CollectionSum>
                <Dependency path="/filersWithHsaContributions/*/hsaTotalDeductibleAmount" />
              </CollectionSum>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>


    <Fact path="/filers/*/additionToHsaContributionLimit">
      <Description>Form 8889 Line 7: Addition to the contribution limit</Description>
      <Export mef="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Round>
                <Switch>
                  <Case>
                    <When>
                      <All>
                        <Dependency path="../wasEligibleToMakeHsaContributionsAllYear" />
                        <Dependency module="filers" path="../age55OrOlder" />
                        <Dependency path="../isCoveredByFamilyHdhp" />
                        <Dependency module="filers" path="/isMarried" />
                      </All>
                    </When>
                    <Then>
                      <Dependency module="constants" path="/hsaOver55AdditionalCoverageLimit" />
                    </Then>
                  </Case>
                  <Case>
                    <When>
                      <True />
                    </When>
                    <Then>
                      <Dollar>0</Dollar>
                    </Then>
                  </Case>
                </Switch>
              </Round>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <!-- HSA contribution excess calculations -->
    <Fact path="/filers/*/hsaContributionLimitExceeded">
      <Description>Whether the filer has exceeded the HSA contribution limit (line 2 + line 11(line 9 + line 10) is
        greater than line 8)</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <IsComplete>
                <Dependency path="../hsaTotalContributionLimit" />
              </IsComplete>
            </When>
            <Then>
              <GreaterThan>
                <Left>
                  <Dependency path="../hsaContributionsTotal" />
                </Left>
                <Right>
                  <Dependency path="../hsaTotalContributionLimit" />
                </Right>
              </GreaterThan>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionLimitExceededAmount">
      <Description>Whether the filer has exceeded the HSA contribution limit</Description>
      <Derived>
        <Subtract>
          <Minuend>
            <Dependency path="../hsaContributionsTotal" />
          </Minuend>
          <Subtrahends>
            <Dependency path="../hsaTotalContributionLimit" />
          </Subtrahends>
        </Subtract>
      </Derived>
    </Fact>

    <Fact path="/filers/*/causesHsaContributionsOverLimitKnockout">
      <Description>Whether the filer is knocked out when their HSA contributions are over the limit</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="/hsaCoverageAndContributionsSectionIsComplete" />
                <Dependency path="../hsaContributionLimitExceeded" />
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowHsaContributionsOverLimitKnockout">
      <Description>The filer is knocked out when their HSA contributions are over the limit</Description>
      <Export downstreamFacts="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Any>
                <Dependency path="/primaryFiler/causesHsaContributionsOverLimitKnockout" />
                <Dependency path="/secondaryFiler/causesHsaContributionsOverLimitKnockout" />
              </Any>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowHsaContributionsSummaryTableOverageVisibility">
      <Description>Whether the HSA contributions summary table overage should be visible</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="/primaryFiler/causesHsaContributionsOverLimitKnockout" />
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowHsaContributionsSummaryTableOverageVisibilitySpouse">
      <Description>Whether the HSA contributions summary table overage should be visible</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency path="/secondaryFiler/causesHsaContributionsOverLimitKnockout" />
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaPdfFilerName">
      <Description>The name displayed on the HSA form 8889 used for PDF to combine MFJ names when applicable</Description>
      <Derived>
        <Switch>
          <Case>
            <!-- When MFJ and only one filer has a separate 8889, combine the filers' names -->
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Equal>
                  <Left>
                    <Dependency path="/numberOfFilersRequiredToFileForm8889" />
                  </Left>
                  <Right>
                    <Int>1</Int>
                  </Right>
                </Equal>
              </All>
            </When>
            <Then>
              <Paste sep=",">
                <Dependency module="filers" path="/primaryFiler/fullName" />
                <Dependency module="filers" path="/secondaryFiler/fullName" />
              </Paste>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dependency module="filers" path="../fullName" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasSelfOnlyHdhp">
      <Description>Whether the filer has a self-only HDHP.</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../typeOfHdhpDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/typeOfHdhpOptions">selfOnly</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasFamilyHdhp">
      <Description>Whether the filer has a family HDHP.</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../typeOfHdhpDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/typeOfHdhpOptions">family</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasSelfOnlyOrFamilyHdhp">
      <Description>Whether the filer selected either Self-Only or Family HDHP coverage.</Description>
      <Derived>
        <Any>
          <Dependency path="../hasSelfOnlyHdhp" />
          <Dependency path="../hasFamilyHdhp" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/isCoveredByFamilyHdhp">
      <Description>Whether the filer can be considered covered by the family coverage HDHP</Description>
      <Derived>
        <Any>
          <Dependency path="/hsaMarriedFilersHaveFamilyCoverage" />
          <Dependency path="../hasFamilyHdhp" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/isCoveredByFamilyHdhpForExport">
      <Description>Form 8889 Line 1 checkbox for PDF, XML export.</Description>
      <Export mef="true" />
      <Derived>
        <All>
          <Dependency path="../hasMadeContributionsToHsa" />
          <Dependency path="../isCoveredByFamilyHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/isCoveredBySelfOnlyHdhp">
      <Description>Whether the filer can be considered covered by the self-only coverage HDHP</Description>
      <Derived>
        <All>
          <Not>
            <Dependency path="../isCoveredByFamilyHdhp" />
          </Not>
          <Dependency path="../hasSelfOnlyHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/isCoveredBySelfOnlyHdhpForExport">
      <Description>Form 8889 Line 1 checkbox for PDF, XML export.</Description>
      <Export mef="true" />
      <Derived>
        <All>
          <Dependency path="../hasMadeContributionsToHsa" />
          <Dependency path="../isCoveredBySelfOnlyHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/belongsToPrimaryFiler">
      <Description>The HSA distribution belongs to the primary filer</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../filer" />
          </Left>
          <Right>
            <Dependency module="filers" path="/primaryFiler" />
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/belongsToSecondaryFiler">
      <Description>The HSA distribution belongs to the secondary filer</Description>
      <Derived>
        <Not>
          <Equal>
            <Left>
              <Dependency path="../filer" />
            </Left>
            <Right>
              <Dependency module="filers" path="/primaryFiler" />
            </Right>
          </Equal>
        </Not>
      </Derived>
    </Fact>

    <Fact path="/primaryFilerHsaDistributions">
      <Name>Primary Filer HSA distributions</Name>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/primaryFiler/hasHsaCanHaveDistribution" />
            </When>
            <Then>
              <Filter path="/hsaDistributions">
                <Dependency path="belongsToPrimaryFiler" />
              </Filter>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/primaryFilerDistributionsRolloverAmountTotal">
      <Description>Primary filer total HSA distributions rollover amount</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/primaryFilerHsaDistributions/*/distributionsRolloverAmount" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/secondaryFilerHsaDistributions">
      <Name>Secondary Filer HSA distributions</Name>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="/secondaryFiler/hasHsaCanHaveDistribution" />
            </When>
            <Then>
              <Filter path="/hsaDistributions">
                <Not>
                  <Dependency path="belongsToPrimaryFiler" />
                </Not>
              </Filter>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/secondaryFilerDistributionsRolloverAmountTotal">
      <Description>Secondary filer total HSA distributions rollover amount</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/secondaryFilerHsaDistributions/*/distributionsRolloverAmount" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/causesUnqualifiedDistributionsKnockout">
      <Description>Whether the filer is knocked out due to entering unqualified distributions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="/someFilerCanHaveDistribution" />
                <IsComplete>
                  <Dependency path="../writableQualifiedMedExpenses" />
                </IsComplete>
                <GreaterThan>
                  <Left>
                    <Dependency path="../modifiedDistribution" />
                  </Left>
                  <Right>
                    <Dependency path="../writableQualifiedMedExpenses" />
                  </Right>
                </GreaterThan>
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaUnqualifiedDistributions">
      <Description>Knockout due to filer entering a value for Box 4 of form 1099-SA</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/hsaDistributions/*/causesUnqualifiedDistributionsKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/hsaDistributions/*/causesFmvKnockout">
      <Description>Whether the filer is knocked out due to their FMV</Description>
      <Derived>
        <All>
          <Dependency path="/someFilerCanHaveDistribution" />
          <IsComplete>
            <Dependency path="../writableFmvOnDateOfDeath" />
          </IsComplete>
          <GreaterThan>
            <Left>
              <Dependency path="../writableFmvOnDateOfDeath" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </GreaterThan>
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaDistributionFMV">
      <Description>Knockout due to filer entering a value for Box 4 of form 1099-SA</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/hsaDistributions/*/causesFmvKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaRolloverTotal">
      <Description>Amount of distributions rolled over into other HSAs</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency module="filers" path="../isSecondaryFiler" />
              </All>
            </When>
            <Then>
              <Dependency path="/secondaryFilerDistributionsRolloverAmountTotal" />
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency module="filers" path="../isPrimaryFiler" />
            </When>
            <Then>
              <Dependency path="/primaryFilerDistributionsRolloverAmountTotal" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/totalHsaDistributions">
      <Description>Appears on Form 8889 line 14a.</Description>
      <Export mef="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency module="filers" path="../isSecondaryFiler" />
              </All>
            </When>
            <Then>
              <Round>
                <CollectionSum>
                  <Dependency path="/secondaryFilerHsaDistributions/*/writableGrossDistribution" />
                </CollectionSum>
              </Round>
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency module="filers" path="../isPrimaryFiler" />
            </When>
            <Then>
              <Round>
                <CollectionSum>
                  <Dependency path="/primaryFilerHsaDistributions/*/writableGrossDistribution" />
                </CollectionSum>
              </Round>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hadOtherCoverageIneligibleForHSAOptions">
      <Description>Enum for if the filer had other health coverage that would make them ineligible for HSA contributions</Description>
      <Derived>
        <EnumOptions>
          <String>wholeYear</String>
          <String>partOfYear</String>
          <String>noneOfYear</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hadOtherCoverageIneligibleForHSA">
      <Description>Duration that filer had other health coverage that would make them ineligible for HSA contributions</Description>
      <Writable>
        <Enum optionsPath="/hadOtherCoverageIneligibleForHSAOptions" />
      </Writable>
    </Fact>

    <Fact path="/filers/*/hadOtherCoverageIneligibleForHsaDerived">
      <Description>Duration that filer had other health coverage that would make them ineligible for HSA contributions
        after accounting for edit conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../flowShouldAskHadCoverageIneligibleForHSAContributions" />
            </When>
            <Then>
              <Dependency path="../hadOtherCoverageIneligibleForHSA" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/causesOtherCoveragePartOfYearKnockOut">
      <Description>Whether filer had other health coverage that would make them ineligible for HSA contributions for
        part of the year</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="/filers/*/hadOtherCoverageIneligibleForHsaDerived" />
          </IsComplete>
          <Equal>
            <Left>
              <Dependency path="/filers/*/hadOtherCoverageIneligibleForHsaDerived" />
            </Left>
            <Right>
              <Enum optionsPath="/hadOtherCoverageIneligibleForHSAOptions">partOfYear</Enum>
            </Right>
          </Equal>
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutOtherCoveragePartOfYear">
      <Description>Knockout due to not having HDHP coverage all year</Description>
      <Export downstreamFacts="true" />
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/causesOtherCoveragePartOfYearKnockOut" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/causesOtherCoverageWholeYearKnockOut">
      <Description>Whether filer had other health coverage that would make them ineligible for HSA contributions for the
        whole year</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="/filers/*/hadOtherCoverageIneligibleForHsaDerived" />
          </IsComplete>
          <Equal>
            <Left>
              <Dependency path="/filers/*/hadOtherCoverageIneligibleForHsaDerived" />
            </Left>
            <Right>
              <Enum optionsPath="/hadOtherCoverageIneligibleForHSAOptions">wholeYear</Enum>
            </Right>
          </Equal>
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutOtherCoverageWholeYear">
      <Description>Knockout due to not having HDHP coverage all year</Description>
      <Export downstreamFacts="true" />
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/causesOtherCoverageWholeYearKnockOut" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaBaseContributionLimit">
      <Description>The filer's HSA base contribution limit, regardless of age.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="../wasEligibleToMakeHsaContributionsAllYear" />
                <Equal>
                  <Left>
                    <Dependency path="../typeOfHdhpDerived" />
                  </Left>
                  <Right>
                    <Enum optionsPath="/typeOfHdhpOptions">selfOnly</Enum>
                  </Right>
                </Equal>
                <Not>
                  <Dependency path="/hsaMarriedFilersHaveFamilyCoverage" />
                </Not>
              </All>
            </When>
            <Then>
              <Dependency module="constants" path="/hsaSelfOnlyCoverageLimit" />
            </Then>
          </Case>
          <Case>
            <When>
              <All>
                <Dependency path="../wasEligibleToMakeHsaContributionsAllYear" />
                <Dependency path="../isCoveredByFamilyHdhp" />
              </All>
            </When>
            <Then>
              <Dependency module="constants" path="/hsaFamilyCoverageLimit" />
            </Then>
          </Case>
          <Case>
            <!-- Partial year coverage would not have $0 limit, but we rely on KOs to ensure that anyone reaching this
            calculation does have $0 limit. -->
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaInitialContributionLimit">
      <Description>Maximum amount of HSA contributions for the tax year. Reported on line 3 of form 8889.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Round>
                <Switch>
                  <Case>
                    <When>
                      <Any>
                        <All>
                          <Dependency path="../wasEligibleToMakeHsaContributionsAllYear" />
                          <Dependency module="filers" path="../age55OrOlder" />
                          <Any>
                            <Dependency path="../isCoveredByFamilyHdhp" />
                            <Dependency path="../isCoveredBySelfOnlyHdhp" />
                          </Any>
                          <Not>
                            <Dependency module="filers" path="/isMarried" />
                          </Not>
                        </All>
                        <All>
                          <Dependency path="../wasEligibleToMakeHsaContributionsAllYear" />
                          <Dependency module="filers" path="../age55OrOlder" />
                          <Dependency path="../isCoveredBySelfOnlyHdhp" />
                          <Dependency module="filers" path="/isMarried" />
                        </All>
                      </Any>
                    </When>
                    <Then>
                      <Add>
                        <Dependency path="../hsaBaseContributionLimit" />
                        <Dependency module="constants" path="/hsaOver55AdditionalCoverageLimit" />
                      </Add>
                    </Then>
                  </Case>
                  <Case>
                    <When>
                      <True />
                    </When>
                    <Then>
                      <Dependency path="../hsaBaseContributionLimit" />
                    </Then>
                  </Case>
                </Switch>
              </Round>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasHdhpCoverageAllYear">
      <Description>Whether the filer had HDHP coverage for the whole year</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../hsaHdhpCoverageStatusDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/hsaHdhpCoverageStatusOptions">allYear</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasMetFamilyContributionLimitRule">
      <Description>Whether the filer has met the conditions for a special rule to where we need to calculate the optimal
        line 6 value for the filer.</Description>
      <Derived>
        <All>
          <!-- parent fact is complete -->
          <Dependency path="/hsaMarriedFilersHaveFamilyCoverage" />
          <Dependency path="/bothFilersHaveHsa" />
          <Dependency path="../hasHdhpCoverageAllYear" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaPrimaryFilerContributionTotalLessAddition">
      <Description>Helper calculation for primary: The sum of lines 2 and 11 less line 7.</Description>
      <Derived>
        <Subtract>
          <Minuend>
            <Add>
              <Dependency path="/primaryFiler/hsaNonemployerContributionsTotal" />
              <Dependency path="/primaryFiler/hsaEmployerContributionsAndFundingDistributionTotal" />
            </Add>
          </Minuend>
          <Subtrahends>
            <Dependency path="/primaryFiler/additionToHsaContributionLimit" />
          </Subtrahends>
        </Subtract>
      </Derived>
    </Fact>

    <Fact path="/hsaPrimaryFilerAllocatedContributionLimit">
      <Description>The calculated contribution limit for the primary filer. This should only be used when the filer has
        met the family contribution limit rule.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <LessThan>
                <Left>
                  <Dependency path="/hsaPrimaryFilerContributionTotalLessAddition" />
                </Left>
                <Right>
                  <Dollar>0</Dollar>
                </Right>
              </LessThan>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <Case>
            <When>
              <All>
                <GreaterThan>
                  <Left>
                    <Dependency path="/hsaPrimaryFilerContributionTotalLessAddition" />
                  </Left>
                  <Right>
                    <Dependency path="/primaryFiler/hsaContributionLimitLessMsaContributions" />
                  </Right>
                </GreaterThan>
              </All>
            </When>
            <Then>
              <Dependency path="/primaryFiler/hsaContributionLimitLessMsaContributions" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dependency path="/hsaPrimaryFilerContributionTotalLessAddition" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaSecondaryFilerAllocatedContributionLimit">
      <Description>The calculated contribution limit for the secondary filer. This should only be used when the filer
        has met the family contribution limit rule.</Description>
      <!-- Note: this is not a common fact defined on the filers collection because the secondary and primary filer have
      differring calculations
      and the secondary filers calculation is dependent on the primary filer's which would be a circular dependency if
      defined in a single fact -->
      <Derived>
        <Switch>
          <Case>
            <When>
              <LessThanOrEqual>
                <Left>
                  <Subtract>
                    <Minuend>
                      <Dependency path="/secondaryFiler/hsaContributionLimitLessMsaContributions" />
                    </Minuend>
                    <Subtrahends>
                      <Dependency path="/hsaPrimaryFilerAllocatedContributionLimit" />
                    </Subtrahends>
                  </Subtract>
                </Left>
                <Right>
                  <Dollar>0</Dollar>
                </Right>
              </LessThanOrEqual>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Subtract>
                <Minuend>
                  <Dependency path="/secondaryFiler/hsaContributionLimitLessMsaContributions" />
                </Minuend>
                <Subtrahends>
                  <Dependency path="/hsaPrimaryFilerAllocatedContributionLimit" />
                </Subtrahends>
              </Subtract>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaAllocatedContributionLimit">
      <Description>The calculated contribution limit for the case where both filers have HSAs and are filing jointly and
        we must determine the
        correct contribution limit for each filer</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency module="filers" path="../isPrimaryFiler" />
            </When>
            <Then>
              <Dependency path="/hsaPrimaryFilerAllocatedContributionLimit" />
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency module="filers" path="../isSecondaryFiler" />
            </When>
            <Then>
              <Dependency path="/hsaSecondaryFilerAllocatedContributionLimit" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionLimitLessAddition">
      <Description>Form 8889 Line 6: the contribution limit less the addition in line 7.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Round>
                <Switch>
                  <Case>
                    <When>
                      <Dependency path="../hasMetFamilyContributionLimitRule" />
                    </When>
                    <Then>
                      <Dependency path="../hsaAllocatedContributionLimit" />
                    </Then>
                  </Case>
                  <Case>
                    <When>
                      <True />
                    </When>
                    <Then>
                      <Dependency path="../hsaContributionLimitLessMsaContributions" />
                    </Then>
                  </Case>
                </Switch>
              </Round>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/hsaMarriedFilersHaveFamilyCoverage">
      <Description>Whether the return is for MFJ filers with at least one having family coverage.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <IsComplete>
                  <Dependency path="/primaryFiler/typeOfHdhpDerived" />
                </IsComplete>
                <IsComplete>
                  <Dependency path="/secondaryFiler/typeOfHdhpDerived" />
                </IsComplete>
              </All>
            </When>
            <Then>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Any>
                  <Equal>
                    <Left>
                      <Dependency path="/primaryFiler/typeOfHdhpDerived" />
                    </Left>
                    <Right>
                      <Enum optionsPath="/typeOfHdhpOptions">family</Enum>
                    </Right>
                  </Equal>
                  <Equal>
                    <Left>
                      <Dependency path="/secondaryFiler/typeOfHdhpDerived" />
                    </Left>
                    <Right>
                      <Enum optionsPath="/typeOfHdhpOptions">family</Enum>
                    </Right>
                  </Equal>
                </Any>
              </All>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaContributionLimitLessMsaContributions">
      <Description>Reported on line 5 of form 8889.</Description>
      <!-- This will need to be updated when we support Archer MSAs. -->
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Dependency path="../hsaInitialContributionLimit" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/taxableHsaDistributionTotal">
      <Description>Sets the value for line 16 of form 8889.</Description>
      <!-- This relies on hsa-ko-unqualified-distributions knocking out distributions where `writableGrossDistribution`
      does not equal `writableQualifiedMedExpenses. -->
      <!-- This will need to be updated if we support lines 16 or 17a. -->
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasHsaCanHaveDistribution" />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaCalculatedTaxableHsaDistributionTotal">
      <Description>Reported on line 16 of form 8889.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <NotEqual>
                <Left>
                  <Dependency path="../taxableHsaDistributionTotal" />
                </Left>
                <Right>
                  <Dollar>0</Dollar>
                </Right>
              </NotEqual>
            </When>
            <Then>
              <Dependency path="../taxableHsaDistributionTotal" />
            </Then>
          </Case>
          <Case>
            <When>
              <All>
                <Equal>
                  <Left>
                    <Dependency path="../taxableHsaDistributionTotal" />
                  </Left>
                  <Right>
                    <Dollar>0</Dollar>
                  </Right>
                </Equal>
                <NotEqual>
                  <Left>
                    <Dependency path="../totalHsaDistributions" />
                  </Left>
                  <Right>
                    <Dollar>0</Dollar>
                  </Right>
                </NotEqual>
              </All>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <!-- Left undefined to leave blank if taxableHsaDistributionTotal AND totalHsaDistributions are $0 -->
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/primaryFilerWithdrawnExcessContributionsAmount">
      <Description>Primary filer total HSA distributions excess contributions amount</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/primaryFilerHsaDistributions/*/withdrawnExcessContributionsAmount" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/secondaryFilerWithdrawnExcessContributionsAmount">
      <Description>Secondary filer total HSA distributions excess contributions amount</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/secondaryFilerHsaDistributions/*/withdrawnExcessContributionsAmount" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaTotalExcessContributionsWithdrawnInTime">
      <Description>Amount of HSA excess contributions withdrawn in time</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency module="filers" path="../isSecondaryFiler" />
              </All>
            </When>
            <Then>
              <Dependency path="/secondaryFilerWithdrawnExcessContributionsAmount" />
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency module="filers" path="../isPrimaryFiler" />
            </When>
            <Then>
              <Dependency path="/primaryFilerWithdrawnExcessContributionsAmount" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaRolloversAndTimelyWithdrawals">
      <Description>Reported on line 14b of form 8889.</Description>
      <Export mef="true" />
      <Derived>
        <Add>
          <Dependency path="../hsaTotalExcessContributionsWithdrawnInTime" />
          <Dependency path="../hsaRolloverTotal" />
        </Add>
      </Derived>
    </Fact>

    <Fact path="/primaryFilerHsaQualifiedMedExpenses">
      <Description>Primary filer total HSA qualified medical expenses.</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/primaryFilerHsaDistributions/*/writableQualifiedMedExpenses" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/secondaryFilerHsaQualifiedMedExpenses">
      <Description>Secondary filer total HSA qualified medical expenses.</Description>
      <Derived>
        <Round>
          <CollectionSum>
            <Dependency path="/secondaryFilerHsaDistributions/*/writableQualifiedMedExpenses" />
          </CollectionSum>
        </Round>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaQualifiedMedExpenses">
      <Description>Reported on line 15 of form 8889.</Description>
      <Export mef="true" />
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filingStatus" path="/isFilingStatusMFJ" />
                <Dependency module="filers" path="../isSecondaryFiler" />
              </All>
            </When>
            <Then>
              <Dependency path="/secondaryFilerHsaQualifiedMedExpenses" />
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency module="filers" path="../isPrimaryFiler" />
            </When>
            <Then>
              <Dependency path="/primaryFilerHsaQualifiedMedExpenses" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaNetDistributionAmount">
      <Description>Determines the net amount of HSA distributions.</Description>
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <GreaterThan>
                <Left>
                  <Add>
                    <Dependency path="../totalHsaDistributions" />
                    <Dependency path="../hsaRolloversAndTimelyWithdrawals" />
                  </Add>
                </Left>
                <Right>
                  <Dollar>0</Dollar>
                </Right>
              </GreaterThan>
            </When>
            <Then>
              <GreaterOf>
                <Dollar>0</Dollar>
                <Subtract>
                  <Minuend>
                    <Dependency path="../totalHsaDistributions" />
                  </Minuend>
                  <Subtrahends>
                    <Dependency path="../hsaRolloversAndTimelyWithdrawals" />
                  </Subtrahends>
                </Subtract>
              </GreaterOf>
            </Then>
          </Case>
          <!-- Left undefined to avoid zero output when minuend and subtrahend are both zero, and unexported. -->
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hsaCalculatedDistributionAmount">
      <Description>Reported on line 14c of form 8889.</Description>
      <Export mef="true" />
      <ExportZero />
      <Derived>
        <Switch>
          <Case>
            <When>
              <NotEqual>
                <Left>
                  <Dependency path="../hsaNetDistributionAmount" />
                </Left>
                <Right>
                  <Dollar>0</Dollar>
                </Right>
              </NotEqual>
            </When>
            <Then>
              <Dependency path="../hsaNetDistributionAmount" />
            </Then>
          </Case>
          <Case>
            <When>
              <All>
                <Equal>
                  <Left>
                    <Dependency path="../hsaNetDistributionAmount" />
                  </Left>
                  <Right>
                    <Dollar>0</Dollar>
                  </Right>
                </Equal>
                <NotEqual>
                  <Left>
                    <Dependency path="../totalHsaDistributions" />
                  </Left>
                  <Right>
                    <Dollar>0</Dollar>
                  </Right>
                </NotEqual>
              </All>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <!-- Left undefined to leave blank if hsaNetDistributionAmount AND totalHsaDistributions are $0 -->
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/changeInMaritalStatusDuringTaxYearOptions">
      <Description>Enum for filer marital status changed this tax year options</Description>
      <Derived>
        <EnumOptions>
          <String>wasMarriedOrDivorcedThisYear</String>
          <String>wasNotMarriedNorDivorcedThisYear</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableChangeInMaritalStatusDuringTaxYear">
      <Description>(Writable) Whether the taxpayer declared they experienced a change in marital status during this tax
        year.</Description>

      <Writable>
        <Enum optionsPath="/changeInMaritalStatusDuringTaxYearOptions" />
      </Writable>
    </Fact>

    <Fact path="/filers/*/changeInMaritalStatusDuringTaxYear">
      <Description>Whether the taxpayer declared they experienced a change in marital status during this tax year.</Description>

      <Derived>
        <Switch>
          <!-- SCENARIO: User has answered `hsa-coverage-marital-status` screen. -->
          <Case>
            <When>
              <Dependency path="../flowShouldAskForChangeInMaritalStatusDuringTaxYear" />
            </When>
            <Then>
              <Equal>
                <Left>
                  <Dependency path="../writableChangeInMaritalStatusDuringTaxYear" />
                </Left>
                <Right>
                  <Enum optionsPath="/changeInMaritalStatusDuringTaxYearOptions">wasMarriedOrDivorcedThisYear</Enum>
                </Right>
              </Equal>
            </Then>
          </Case>
          <!-- SCENARIO: User has not answered `hsa-coverage-marital-status` screen. -->
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/checkForChangeInMaritalStatusDuringTaxYear">
      <Description>Whether to show screen asking if the filer experienced a change in marital status this tax year.</Description>
      <Derived>
        <All>
          <!-- They should be asked for change in marital status if they are not single ... -->
          <Not>
            <Dependency module="filers" path="/isSingle" />
          </Not>
          <!-- ... AND they did not have any other disqualifying health coverage. -->
          <Switch>
            <!-- SCENARIO: User has answered question on `hsa-coverage-other-y-n`. -->
            <Case>
              <When>
                <IsComplete>
                  <Dependency path="../hadOtherCoverageIneligibleForHsaDerived" />
                </IsComplete>
              </When>
              <Then>
                <Equal>
                  <Left>
                    <Dependency path="../hadOtherCoverageIneligibleForHsaDerived" />
                  </Left>
                  <Right>
                    <Enum optionsPath="/hadOtherCoverageIneligibleForHSAOptions">noneOfYear</Enum>
                  </Right>
                </Equal>
              </Then>
            </Case>
            <!-- SCENARIO: User has not answered question on `hsa-coverage-other-y-n`. -->
            <Case>
              <When>
                <True />
              </When>
              <Then>
                <True />
              </Then>
            </Case>
          </Switch>
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowShouldAskForChangeInMaritalStatusDuringTaxYear">
      <Description>Whether to show the screen asking a filer experienced a change in marital status this tax year.</Description>
      <Derived>
        <All>
          <Dependency path="../hasMadeContributionsToHsa" />
          <Dependency path="../checkForChangeInMaritalStatusDuringTaxYear" />
        </All>
      </Derived>
    </Fact>

    <!-- checkIfChangeInMaritalStatusAffectsContributionLimit &
    flowShouldAskIfChangeInMaritalStatusAffectsContributionLimit could probably be removed -->
    <Fact path="/filers/*/checkIfChangeInMaritalStatusAffectsContributionLimit">
      <Description>Whether to show screen asking if a change in marital status this tax year affects the filer's
        contribution limit.</Description>
      <Derived>
        <All>
          <Dependency path="../changeInMaritalStatusDuringTaxYear" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowShouldAskIfChangeInMaritalStatusAffectsContributionLimit">
      <Description>Whether to show the screen asking if a change in marital status affects a filer's contribution limit.</Description>

      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="../checkIfChangeInMaritalStatusAffectsContributionLimit" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableMaritalChangeAffectContributionLimitBool">
      <Description>Whether any of the distributions from box 6 are a rollover to another HSA</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/filers/*/causesMaritalChangeAffectsContributionLimitKnockout">
      <Description>Used in the flow to determine whether to show Form 8889 line 6 knockout.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency path="../flowShouldAskIfChangeInMaritalStatusAffectsContributionLimit" />
                <IsComplete>
                  <Dependency path="../writableMaritalChangeAffectContributionLimitBool" />
                </IsComplete>
              </All>
            </When>
            <Then>
              <Dependency path="../writableMaritalChangeAffectContributionLimitBool" />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutMaritalChangeAffectsContributionLimit">
      <Name>Knockout when the filer/spouse contribution limit is affected by marital status change this tax year.</Name>
      <Description>At least one Form 8889 has a set of facts that cause a knockout</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/causesMaritalChangeAffectsContributionLimitKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasMadeQualifiedHsaFundingDistribution">
      <Description>Whether the filer has made qualified HSA funding distributions</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/filers/*/hasMadeQualifiedHsaFundingDistributionDerived">
      <Description>Whether the filer has made qualified HSA funding distributions after accounting for edit conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Dependency path="../hasMadeQualifiedHsaFundingDistribution" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutMadeQualifiedHsaFundingDistribution">
      <Description>Knockout due to a qualified HSA funding distribution</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <Any>
          <Dependency path="/primaryFiler/hasMadeQualifiedHsaFundingDistributionDerived" />
          <Dependency path="/secondaryFiler/hasMadeQualifiedHsaFundingDistributionDerived" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/someFilersMadeTestingPeriodContribution">
      <Description>Whether TP made HSA contribution during testing period of TP - 1</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/flowHsaTestingPeriodCheckYes">
      <Name>TP has additional conctributions during testing period TY-1</Name>
      <Description>TP confirmed addtional contributions during testing period TY-1</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="/someFilersMadeTestingPeriodContribution" />
          </IsComplete>
          <Dependency path="/someFilersMadeTestingPeriodContribution" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/someFilersHaveTestingPeriodAdditionalIncome">
      <Description>Whether TP have additional income due to use of last month rule during testing period of TP - 1</Description>
      <Writable>
        <Boolean />
      </Writable>
    </Fact>

    <Fact path="/flowKnockoutHsaTestingPeriodAdditionalIncomeYes">
      <Name>Knockout because of additional income resulting from use of the last-month rule</Name>
      <Description>TP has additonal income to report resulting from use of the last-month rule</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <All>
          <Dependency path="/flowShowHsaTestingPeriodContributionCheck" />
          <Dependency path="/flowHsaTestingPeriodCheckYes" />
          <IsComplete>
            <Dependency path="/someFilersHaveTestingPeriodAdditionalIncome" />
          </IsComplete>
          <Dependency path="/someFilersHaveTestingPeriodAdditionalIncome" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/hasToShowTestingPeriodCheck">
      <Description>Whether the filer does not have W2 HSA and do not have HSA activity.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <Dependency module="filers" path="../isPrimaryFilerOrMfjAndEither" />
                <IsComplete>
                  <Dependency path="../flowSkipToHsaTestingPeriodContributionCheck" />
                </IsComplete>
                <Dependency path="../flowSkipToHsaTestingPeriodContributionCheck" />
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <!-- TP reported having non-employer(W2) contributions, but the filer had contributions in the TY -->
              <All>
                <Dependency module="filers" path="../isPrimaryFilerOrMfjAndEither" />
                <Dependency path="/flowShowHsaYesNo" />
                <Dependency path="/someFilerHadNonEmployerHsaActivity" />
                <Not>
                  <Dependency path="../mayHaveHsaContributions" />
                </Not>
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filersTestingPeriodCheck">
      <Description>The collection of filers which need to go to testing period contribution check</Description>

      <Derived>
        <Filter path="/filers">
          <Dependency path="hasToShowTestingPeriodCheck" />
        </Filter>
      </Derived>
    </Fact>

    <Fact path="/bothFilersHaveToShowTestingPeriodCheck">
      <Description>Whether the filing status is MFJ and both filers have separate HSAs</Description>
      <Derived>
        <Equal>
          <Left>
            <CollectionSize>
              <Dependency path="/filersTestingPeriodCheck" />
            </CollectionSize>
          </Left>
          <Right>
            <Int>2</Int>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/flowShowHsaTestingPeriodContributionCheck">
      <Description>Show testing period contributions check</Description>
      <Derived>
        <Any>
          <Dependency path="/primaryFiler/hasToShowTestingPeriodCheck" />
          <Dependency path="/secondaryFiler/hasToShowTestingPeriodCheck" />
          <Dependency path="/bothFilersHaveToShowTestingPeriodCheck" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/knockoutNoPaymentsHsaDistribution">
      <Description>Filer is knocked out if they have no taxable income and no credits, but have HSA distributions. </Description>
      <Export downstreamFacts="true" />
      <Derived>
        <All>
          <Not>
            <Dependency module="estimatedPayments" path="/paidEstimatedTaxesOrFromLastYear" />
          </Not>
          <Dependency module="taxCalculations" path="/knockoutHasNoPaymentsOrCredits" />
          <Equal>
            <Left>
              <Dependency module="interest" path="/taxExemptInterest" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </Equal>
          <Equal>
            <Left>
              <Dependency module="income" path="/pensionsAndAnnuities" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </Equal>
          <Equal>
            <Left>
              <Dependency module="socialSecurity" path="/socialSecurityBenefits" />
            </Left>
            <Right>
              <Dollar>0</Dollar>
            </Right>
          </Equal>
          <Any>
            <Dependency path="/primaryFiler/hasHsaDistributions" />
            <Dependency path="/secondaryFiler/hasHsaDistributions" />
          </Any>
        </All>
      </Derived>
    </Fact>

    <Fact path="/hsaTestingPeriodCheckSectionIsComplete">
      <Description>Whether the TP has answered all the required sections in the HSA testing period contribution check</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <!-- section is available, last screen answered -->
              <All>
                <Dependency path="/flowShowHsaTestingPeriodContributionCheck" />
                <IsComplete>
                  <Dependency path="/someFilersMadeTestingPeriodContribution" />
                </IsComplete>
                <Any>
                  <Not>
                    <Dependency path="/flowHsaTestingPeriodCheckYes" />
                  </Not>
                  <IsComplete>
                    <Dependency path="/someFilersHaveTestingPeriodAdditionalIncome" />
                  </IsComplete>
                </Any>
              </All>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <!-- section is not available -->
              <Not>
                <Dependency path="/flowShowHsaTestingPeriodContributionCheck" />
              </Not>
            </When>
            <Then>
              <True />
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <False />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <!-- Refactor -->
    <Fact path="/filers/*/hasHsaCanHaveDistribution">
      <Description>Whether the filer has HSA and therefore can have distributions</Description>
      <Derived>
        <Dependency path="../mayHaveHsaContributions" />
      </Derived>
    </Fact>

    <!-- We can remove this entirely and replace with /filersWithHsa -->
    <Fact path="/filersWithHsaCanHaveDistribution">
      <Description>The collection of filers with HSA that can have distributions</Description>
      <Derived>
        <Filter path="/filers">
          <Dependency path="hasHsaCanHaveDistribution" />
        </Filter>
      </Derived>
    </Fact>

    <Fact path="/someFilerCanHaveDistribution">
      <Description>Whether at least one filer has HSA and can have distributions.</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <CollectionSize>
              <Dependency path="/filersWithHsaCanHaveDistribution" />
            </CollectionSize>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/enrolledInMedicareOptions">
      <Description>Enum for filer Medicare enrollment values</Description>
      <Derived>
        <EnumOptions>
          <String>allYear</String>
          <String>partOfYear</String>
          <String>noneOfYear</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/filers/*/enrolledInMedicare">
      <Description>Whether filer was enrolled in Medicare all, part, or none of the year</Description>
      <Writable>
        <Enum optionsPath="/enrolledInMedicareOptions" />
      </Writable>
    </Fact>


    <Fact path="/filers/*/enrolledInMedicareDerived">
      <Description>The filers enrolledInMedicare answer after accounting for edit conditions.</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../hasMadeContributionsToHsa" />
            </When>
            <Then>
              <Dependency path="../enrolledInMedicare" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>


    <Fact path="/filers/*/flowEnrolledInMedicarePartOfYear">
      <Description>Whether filer was enrolled in Medicare part of the year</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../enrolledInMedicareDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/enrolledInMedicareOptions">partOfYear</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowNotEnrolledInHdhp">
      <Description>Whether filer was not enrolled in HDHP</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="/filers/*/hsaHdhpCoverageStatusDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/hsaHdhpCoverageStatusOptions">noneOfYear</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowEnrolledInMedicareAllYear">
      <Description>Whether filer was enrolled in Medicare for the whole year</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../enrolledInMedicareDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/enrolledInMedicareOptions">allYear</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/enrolledInMedicarePartOfYearKnockout">
      <Description>Whether the filer was knocked out of the flow due to their answer to medicare enrollment</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../flowEnrolledInMedicarePartOfYear" />
          </IsComplete>
          <Dependency path="../flowEnrolledInMedicarePartOfYear" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/notEnrolledInHdhpKnockout">
      <Description>Whether the filer was knocked out of the flow due to not being enrolled in HDHP</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../flowNotEnrolledInHdhp" />
          </IsComplete>
          <Dependency path="../flowNotEnrolledInHdhp" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/filers/*/enrolledInMedicareAllYearKnockout">
      <Description>Whether the filer was knocked out of the flow due to medicare enrollment for the whole year </Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../flowEnrolledInMedicareAllYear" />
          </IsComplete>
          <Dependency path="../flowEnrolledInMedicareAllYear" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaCoverageChanging">
      <Description>Knockout due to Medicare coverage changing during the year </Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/enrolledInMedicarePartOfYearKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutNotEnrolledInHdhp">
      <Description>Knockout due to not being enrolled in HDHP </Description>
      <Export downstreamFacts="true" />
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/notEnrolledInHdhpKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutEnrolledInMedicareAllYear">
      <Description>Knockout due to Medicare coverage during the whole year </Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/enrolledInMedicareAllYearKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/typeOfHdhpOptions">
      <Description>Enum for filer High Deductible Health Plan coverage values</Description>
      <Derived>
        <EnumOptions>
          <String>selfOnly</String>
          <String>family</String>
          <String>both</String>
        </EnumOptions>
      </Derived>
    </Fact>

    <Fact path="/filers/*/typeOfHdhp">
      <Description>Filer's type of HDHP coverage</Description>
      <Writable>
        <Enum optionsPath="/typeOfHdhpOptions" />
      </Writable>
    </Fact>

    <Fact path="/filers/*/typeOfHdhpDerived">
      <Description>Filer's HDHP coverage after accounting for edit conditions</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../flowShouldAskForHsaHdhpCoverageType" />
            </When>
            <Then>
              <Dependency path="../typeOfHdhp" />
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/flowBothSelfAndFamilyHdhpCoverage">
      <Description>Whether filer had both self and family HDHP coverage</Description>
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../typeOfHdhpDerived" />
          </Left>
          <Right>
            <Enum optionsPath="/typeOfHdhpOptions">both</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>

    <Fact path="/filers/*/typeOfHdhpKnockout">
      <Description>Whether the filer was knocked out of the flow due to their answer to self and family HDHP coverage</Description>
      <Derived>
        <All>
          <IsComplete>
            <Dependency path="../flowBothSelfAndFamilyHdhpCoverage" />
          </IsComplete>
          <Dependency path="../flowBothSelfAndFamilyHdhpCoverage" />
        </All>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaSelfAndFamilyCoverage">
      <Description>Knockout due to having both self and family HDHP coverage </Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/typeOfHdhpKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHdhpCoverageNotAllYear">
      <Description>Knockout due to not having HDHP coverage all year</Description>
      <Derived>
        <GreaterThan>
          <Left>
            <Count>
              <Dependency path="/filers/*/hsaHdhpCoverageStatusKnockout" />
            </Count>
          </Left>
          <Right>
            <Int>0</Int>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHsaCoverage">
      <Description>Knockout due to HSA coverage details</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />

      <Derived>
        <Any>
          <Dependency path="/flowKnockoutHsaCoverageChanging" />
          <Dependency path="/flowKnockoutHsaSelfAndFamilyCoverage" />
          <Dependency path="/flowKnockoutHdhpCoverageNotAllYear" />
          <Dependency path="/flowKnockoutOtherCoveragePartOfYear" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutContributionSummaryNoneAllowed">
      <Name>Knockout with summary conditions, due to hsa contributions made by TP not eligible to make contributions</Name>
      <Description>Multiple coditons met on multiple HSA screens</Description>
      <Export downstreamFacts="true" />
      <BlockSubmissionOnTrue />
      <Derived>
        <Any>
          <!-- Conditions from hsa-coverage-medicare-status -->
          <Dependency path="/flowKnockoutEnrolledInMedicareAllYear" />
          <!-- Conditions from hsa-coverage-status -->
          <Dependency path="/flowKnockoutNotEnrolledInHdhp" />
          <!-- hsa-coverage-other-y-n -->
          <Dependency path="/flowKnockoutOtherCoverageWholeYear" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/flowKnockoutHdhpCoverageStatusNotNeeded">
      <Description>Knockout due to either Medicare enrollment for full year or part of the year</Description>
      <Export downstreamFacts="true" />
      <Derived>
        <Any>
          <Dependency path="/flowKnockoutHsaCoverageChanging" />
          <Dependency path="/flowKnockoutEnrolledInMedicareAllYear" />
        </Any>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableHsaNonemployerContributionsTaxYear">
      <Description>Filer's nonemployer HSA contributions this tax year</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/filers/*/hsaNonemployerContributionsTaxYear">
      <Description>Filer's nonemployer HSA contributions this tax year</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <IsComplete>
                  <Dependency path="../writableHsaNonemployerContributionsTaxYear" />
                </IsComplete>
                <Dependency path="../hasMadeContributionsToHsa" />
              </All>
            </When>
            <Then>
              <Round>
                <Dependency path="../writableHsaNonemployerContributionsTaxYear" />
              </Round>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0.00</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>

    <Fact path="/filers/*/writableHsaNonemployerContributionsTaxYearPlusOne">
      <Description>Filer's nonemployer HSA contributions tax year plus one</Description>
      <Writable>
        <Dollar />
        <Limit type="Min">
          <Dollar>0</Dollar>
        </Limit>
      </Writable>
    </Fact>

    <Fact path="/filers/*/hsaNonemployerContributionsTaxYearPlusOne">
      <Description>Filer's nonemployer HSA contributions tax year plus one</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <All>
                <IsComplete>
                  <Dependency path="../writableHsaNonemployerContributionsTaxYearPlusOne" />
                </IsComplete>
                <Dependency path="../hasMadeContributionsToHsa" />
              </All>
            </When>
            <Then>
              <Round>
                <Dependency path="../writableHsaNonemployerContributionsTaxYearPlusOne" />
              </Round>
            </Then>
          </Case>
          <Case>
            <When>
              <True />
            </When>
            <Then>
              <Dollar>0.00</Dollar>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
  </Facts>
</FactDictionaryModule>
